<?xml version="1.0" encoding="utf-8"?>
<templates xml:space="preserve">
    <t t-name="project.ProjectRightSidePanel" owl="1">
        <div t-if="projectId" class="o_rightpanel pt-0 bg-view border-start overflow-auto">
            
            <ProjectRightSidePanelSection
                name="'stat_buttons'"
                header="false"
                show="!!(state &amp;&amp; state.data &amp;&amp; state.data.buttons)"
            >
                <div class="o_form_view">
                    <div class="oe_button_box o-form-buttonbox d-flex flex-wrap">
                        <t t-foreach="state.data.buttons" t-as="button" t-key="button.action">
                            <ViewButton
                                t-if="button.show and button.action !== 'action_view_sos'"
                                defaultRank="'oe_stat_button'"
                                className="'h-auto py-2 border border-start-0 border-top-0 text-start'"
                                icon="'fa-' + button.icon"
                                title="button.text"
                                clickParams="_getStatButtonClickParams(button)"
                                record="_getStatButtonRecordParams()"
                            >
                                <t t-set-slot="contents">
                                    <div class="o_field_widget o_stat_info">
                                        <span class="o_stat_value text-start">
                                            <t t-esc="button.number"/>
                                        </span>
                                        <span class="o_stat_text">
                                            <t t-esc="button.text"/>
                                        </span>
                                    </div>
                                </t>
                            </ViewButton>
                        </t>
                    </div>
                </div>
            </ProjectRightSidePanelSection>
            
            <!-- Participants section with error handling -->
            <ProjectRightSidePanelSection
                name="'participants'"
                show="!!(state &amp;&amp; state.data &amp;&amp; state.data.participants &amp;&amp; state.data.participants.total &gt; 0)"
            >
                <t t-set-slot="title" owl="1">
                    Participants
                </t>
                
                <t t-if="state &amp;&amp; state.data &amp;&amp; state.data.participants &amp;&amp; state.data.participants.data">
                    <div class="participant-actions-container mb-3">
                        <button
                            t-if="state.data.participants.pending &gt; 0"
                            onclick="typeof markAllParticipantsCompleted === 'function' &amp;&amp; markAllParticipantsCompleted(event)"
                            t-att-data-project-id="projectId"
                            class="btn btn-success mb-2 w-100"
                            type="button"
                        >
                            <i class="fa fa-check-circle me-2"></i>
                            Mark All Test Completed
                        </button>
                        
                        <!-- Participants count info -->
                        <div class="text-muted small mb-2">
                            <i class="fa fa-info-circle me-1"></i>
                            <span t-esc="state.data.participants.completed || 0"/> completed, 
                            <span t-esc="state.data.participants.pending || 0"/> pending
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Mobile</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr t-foreach="state.data.participants.data" t-as="p" t-key="p.id" class="participant-row">
                                    <td>
                                        <strong t-esc="p.first_name"/> <t t-esc="p.last_name"/>
                                    </td>
                                    <td>
                                        <small t-esc="p.email_address"/>
                                    </td>
                                    <td>
                                        <small t-esc="p.mobile_phone"/>
                                    </td>
                                    <td>
                                        <span t-esc="p.state"/>
                                    </td>
                                    <td>
                                        <!-- Pending participants actions -->
                                        <div t-if="p.state === 'not_yet_confirmed'" class="btn-group btn-group-sm" role="group">
                                            <button 
                                                onclick="typeof setParticipantConfirmed === 'function' &amp;&amp; setParticipantConfirmed(event)" 
                                                t-att-data-id="p.id" 
                                                class="btn btn-success btn-sm" 
                                                title="Complete"
                                                type="button"
                                            >
                                                <i class="fa fa-check"/>
                                            </button>
                                            <button 
                                                onclick="typeof setParticipantRescheduled === 'function' &amp;&amp; setParticipantRescheduled(event)" 
                                                t-att-data-id="p.id" 
                                                class="btn btn-warning btn-sm" 
                                                title="Reschedule"
                                                type="button"
                                            >
                                                <i class="fa fa-clock-o"/>
                                            </button>
                                            <button 
                                                onclick="typeof setParticipantCancelled === 'function' &amp;&amp; setParticipantCancelled(event)" 
                                                t-att-data-id="p.id" 
                                                class="btn btn-danger btn-sm" 
                                                title="Cancel"
                                                type="button"
                                            >
                                                <i class="fa fa-times"/>
                                            </button>
                                        </div>
                                        
                                        <!-- Completed/Cancelled/Rescheduled participants -->
                                        <div t-if="p.state !== 'not_yet_confirmed'" class="d-flex align-items-center justify-content-between">
                                            <div>
                                                <span t-if="p.state === 'confirmed'" class="badge bg-success">
                                                    <i class="fa fa-check me-1"></i>Completed
                                                </span>
                                                <span t-if="p.state === 'rescheduled'" class="badge bg-warning text-dark">
                                                    <i class="fa fa-clock-o me-1"></i>Rescheduled
                                                </span>
                                                <span t-if="p.state === 'cancelled'" class="badge bg-danger">
                                                    <i class="fa fa-times me-1"></i>Cancelled
                                                </span>
                                            </div>
                                            <button 
                                                onclick="typeof setParticipantReset === 'function' &amp;&amp; setParticipantReset(event)" 
                                                t-att-data-id="p.id" 
                                                class="btn btn-info btn-sm ms-2" 
                                                title="Reset to Pending"
                                                type="button"
                                            >
                                                <i class="fa fa-undo"/>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Empty state -->
                    <div t-if="!state.data.participants.data.length" class="text-center text-muted py-4">
                        <i class="fa fa-users fa-2x mb-2 d-block"></i>
                        <p>No participants found</p>
                    </div>
                </t>
            </ProjectRightSidePanelSection>
            
            <!-- Milestones section -->
            <ProjectRightSidePanelSection
                name="'milestones'"
                show="!!(state &amp;&amp; state.data &amp;&amp; state.data.milestones &amp;&amp; state.data.milestones.data)"
            >
                <t t-set-slot="header" owl="1">
                    <span class="btn btn-secondary">
                        <div class="o_add_milestone">
                            <a t-on-click="addMilestone">Add Milestone</a>
                        </div>
                    </span>
                </t>
                <t t-set-slot="title" owl="1">
                    Milestones
                </t>
                <div t-foreach="state.data.milestones.data" t-as="milestone" t-key="milestone.id" class="o_rightpanel_data_row">
                    <ProjectMilestone context="context" milestone="milestone" open.bind="openFormViewDialog" load.bind="loadMilestones"/>
                </div>
                <span t-if="state.data.milestones.data.length === 0" class="text-muted fst-italic">
                    Track major progress points that must be reached to achieve success.
                </span>
            </ProjectRightSidePanelSection>
        </div>
        <div t-else=""/>
    </t>
</templates>